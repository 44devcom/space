---
alwaysApply: true
---
# FastAPI Docker Service (Production Configuration)

## Overview
FastAPI is a modern, high-performance Python web framework used to build REST APIs
for the car market application. This service provides the backend API endpoints
for managing car listings, including CRUD operations for the Car model.

It provides:
- RESTful API endpoints for car management
- Automatic OpenAPI/Swagger documentation
- Database integration with MySQL via SQLAlchemy
- Redis integration for caching and queues
- Health check endpoint for monitoring
- Production-ready uvicorn ASGI server

---

## Image
- **Base image:** `python:3.11-slim`
- Multi-stage build for optimized production image
- Non-root user execution for security

---

## Ports
- **8000** – FastAPI application port

Example access:
- http://localhost:8000
- http://localhost:8000/docs (Swagger UI)
- http://localhost:8000/redoc (ReDoc)
- http://localhost:8000/health (Health check)

---

## Environment Variables (Required)
```bash
DB_HOST=db
DB_PORT=3306
DB_DATABASE=cars
DB_USERNAME=root
DB_PASSWORD=secret
REDIS_HOST=queue
REDIS_PORT=6379
QUEUE_CONNECTION=redis
MAIL_HOST=mail
MAIL_PORT=1025
APP_ENV=production
APP_DEBUG=false
APP_URL=http://localhost
```

### Security Recommendations
- Never expose `DB_PASSWORD` in logs or version control
- Use strong passwords in production
- Set `APP_DEBUG=false` in production
- Use environment-specific `APP_ENV` values

---

## Volumes
For development, source code is mounted as read-only:
- `../src:/app/src:ro` – Application source code
- `../tests:/app/tests:ro` – Test files

For production, code should be copied into the image (not mounted).

---

## docker-compose Example
```yaml
api:
  build:
    context: ..
    dockerfile: docker/Dockerfile
    target: production
  container_name: car-market-api
  environment:
    DB_HOST: db
    DB_PORT: 3306
    DB_DATABASE: ${DB_DATABASE:-cars}
    DB_USERNAME: ${DB_USERNAME:-root}
    DB_PASSWORD: ${DB_PASSWORD:-secret}
    REDIS_HOST: queue
    REDIS_PORT: 6379
    QUEUE_CONNECTION: redis
    MAIL_HOST: mail
    MAIL_PORT: 1025
    MAIL_USER: ${MAIL_USER:-null}
    MAIL_PASSWORD: ${MAIL_PASSWORD:-null}
    MAIL_FROM: ${MAIL_FROM:-no-reply@cars.com}
    APP_ENV: ${APP_ENV:-production}
    APP_DEBUG: ${APP_DEBUG:-false}
    APP_URL: ${APP_URL:-http://localhost}
  ports:
    - "${API_PORT:-8000}:8000"
  depends_on:
    db:
      condition: service_healthy
    queue:
      condition: service_healthy
    mail:
      condition: service_started
  networks:
    - car-market-network
  restart: unless-stopped
  volumes:
    - ../src:/app/src:ro
    - ../tests:/app/tests:ro
```

---

## FastAPI Configuration Example

### Application Structure
```
src/
  main.py              # FastAPI app instance
  api/
    routes/            # API route definitions
    controllers/       # Request handlers
    schemas/           # Pydantic models
  domain/
    entities/          # Domain entities (e.g., Car)
    repositories/      # Repository interfaces
  infrastructure/
    db/                # Database configuration
    orm/               # SQLAlchemy models
```

### Car Model Example
Based on the Car schema, the FastAPI service should expose endpoints for:
- `GET /api/cars` – List all cars
- `GET /api/cars/{id}` – Get car by ID
- `POST /api/cars` – Create new car
- `PUT /api/cars/{id}` – Update car
- `DELETE /api/cars/{id}` – Delete car

### Pydantic Model Example
```python
from pydantic import BaseModel, Field
from typing import Optional, List

class CarBase(BaseModel):
    make: str
    model: str
    year: int
    color: Optional[str] = None
    price: Optional[float] = None
    mileage: Optional[float] = None
    vin: Optional[str] = None
    is_available: Optional[bool] = Field(default=True, alias="isAvailable")
    features: Optional[List[str]] = None

    class Config:
        populate_by_name = True

class CarCreate(CarBase):
    pass

class CarResponse(CarBase):
    id: str

    class Config:
        from_attributes = True
```

### Database Connection Example
```python
from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker
import os

DATABASE_URL = (
    f"mysql+pymysql://{os.getenv('DB_USERNAME')}:{os.getenv('DB_PASSWORD')}"
    f"@{os.getenv('DB_HOST')}:{os.getenv('DB_PORT')}/{os.getenv('DB_DATABASE')}"
)

engine = create_engine(DATABASE_URL)
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
Base = declarative_base()
```

---

## Healthcheck
FastAPI health check endpoint:
```bash
curl -f http://localhost:8000/health
```

Recommended compose healthcheck:
```yaml
healthcheck:
  test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 5s
```

---

## Logs & Debugging
```bash
docker compose logs -f api
```

View specific log levels:
```bash
docker compose logs api | grep ERROR
docker compose logs api | grep WARNING
```

Access container shell:
```bash
docker compose exec api /bin/bash
```

Test Python environment:
```bash
docker compose exec api python --version
docker compose exec api pip list
```

---

## Notes
- The service uses uvicorn ASGI server for production
- For high-traffic scenarios, consider using gunicorn with uvicorn workers:
  ```bash
  gunicorn src.main:app -k uvicorn.workers.UvicornWorker -b 0.0.0.0:8000 --workers 4
  ```
- The service depends on MySQL (db) and Redis (queue) services
- Source code is mounted read-only in development mode
- In production, ensure code is copied into the image, not mounted
- The service runs as non-root user (appuser) for security

---

## Testing
Test the health endpoint:
```bash
curl http://localhost:8000/health
```

Test the API documentation:
```bash
curl http://localhost:8000/docs
```

Test car endpoints (example):
```bash
# List cars
curl http://localhost:8000/api/cars

# Create car
curl -X POST http://localhost:8000/api/cars \
  -H "Content-Type: application/json" \
  -d '{
    "make": "Toyota",
    "model": "Camry",
    "year": 2023,
    "color": "Blue",
    "price": 25000,
    "mileage": 0,
    "isAvailable": true
  }'

# Get car by ID
curl http://localhost:8000/api/cars/{id}
```

Run tests inside container:
```bash
docker compose exec api python -m pytest tests/
```
